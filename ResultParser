#!/usr/bin/python3.8

from Labeler import Labeler, LabelerMode

# Utility imports
import pyminizip as pyzip
import tempfile
import argparse
import shutil
import os
import re

#########################################################
#														#
#						Main Code						#
#														#
#########################################################

def main(args):

	labeler = Labeler(LabelerMode.Local)

	possitive	= 0
	privilege	= 0
	analyzed 	= 0
	success		= 0
	failure		= 0
	noLogs		= 0
	noSyscall	= 0
	exeFmt		= 0
	other		= 0
	samples 	= []
	privSamples	= []
	failSamples = []
	
	dirPath = os.path.abspath(args.resultsDir)

	for zipFile in os.listdir(dirPath):
	
		analyzed += 1
	
		tmpDir = tempfile.mkdtemp()
	
		pyzip.uncompress(os.path.join(dirPath, zipFile), "ASEPs", tmpDir, 0)
		
		labelingLog = os.path.join(tmpDir, 'labeling.log')
		drakrunLog 	= os.path.join(tmpDir, 'drakrun.log')
		syscallLog 	= os.path.join(tmpDir, 'syscall.log')
		(sampleID, ext)	= os.path.splitext(zipFile)
		
		if(ext != ".zip"): continue
		
		
		if os.path.exists(labelingLog):
		
			success += 1
			
			content = open(labelingLog, 'r').read()
			
			possitives = list(re.findall(r'[a-zA-Z0-9 ]+: POSITIVE', content))[1:]
			
			if possitives: 
			
				possitive += 1
				samples.append(sampleID)
				
		elif os.path.exists(drakrunLog):
		
			failure += 1
		
			content = open(drakrunLog, 'r').read()

			error = re.search(r'"Injection failed with error: ([A-Z_]+)"', content)
			
			if error is None:
			
				noSyscall += 1
				
			elif error.group(1) == "ERROR_ELEVATION_REQUIRED":
			
				privilege += 1
				
			elif error.group(1) == "ERROR_BAD_EXE_FORMAT":
			
				exeFmt += 1
				
			else:
			
				other += 1
			
		else:
		
			failure += 1
			noLogs += 1
		
		shutil.rmtree(tmpDir)
		
	print("Analyzed {0} samples".format(analyzed))
	print("\t{0} failed:".format(failure))
	print("\t\t{0} produced no logs".format(noLogs))
	print("\t\t{0} failed to produce syscall.log".format(noSyscall))
	print("\t\t{0} required privilege elevation to be executed".format(privilege))
	print("\t\t{0} failed due to presenting bad executable format".format(exeFmt))
	print("\t\t{0} failed for other reasons".format(other))
	print("\t{0} where successfully analyzed".format(success))
	print("\t\t{0} where labeled with positive use of ASEPs:".format(possitive))
	for s in samples:
		print("\t\t\t", s)
		
#########################################################
#														#
#					Argument Parsing					#
#														#
#########################################################


if __name__ == "__main__":

	parser = argparse.ArgumentParser(description="Analysis result stats")
	parser.add_argument("--resultsDir", help="Directory in which analysis results are stored", required=True)
	
	args = parser.parse_args()

	main(args)
